<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Use Readline With Default Ruby on OS X - CaiusTheory</title>

    <link rel="alternate" type="application/atom+xml" title="Caius Theory" href="/feed/" />

    <link rel="stylesheet" href="/stylesheets/stylesheet.css" type="text/css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>

    <header>
      <h1><a href="/">Caius Theory</a></h1>
      <h2>Now with even more cowbell&hellip;</h2>
    </header>

    <main>
      <p>OS X Lion comes with ruby 1.8.7-p249 installed, although it's compiled against libedit rather than libreadline. Whilst libedit is a mostly-compatible replacement for libreadline, I find there's a couple of settings I'm used to that don't work in libedit. (Like <code>history-beginning-search-backward</code>.)</p>

<p>Luckily you can grab the source of ruby and compile just the readline extension, and move it into the right place for it to just work. Here's what's been working for me:</p>

<pre><code># Install readline using homebrew
$ brew install readline

# Download the ruby source and check out 1.8.7-p249
$ mkdir ~/tmp &amp;&amp; cd ~/tmp
$ git clone git://github.com/ruby/ruby
$ cd ruby
$ git checkout v1_8_7_249
$ cd ext/readline
$ ruby extconf.rb --with-readline-dir=$(brew --prefix readline) --disable-libedit
$ make
</code></pre>

<p>Now you should have <code>readline.bundle</code> in the current directory, and it should be compiled against your homebrew-installed readline library, rather than libedit that comes with the system. We can quickly double-check that by using <code>otool</code> to check what the binary is linked against.</p>

<pre><code>$ otool -L readline.bundle
readline.bundle:
    /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/libruby.1.dylib (compatibility version 1.8.0, current version 1.8.7)
    /usr/local/Cellar/readline/6.2.2/lib/libreadline.6.2.dylib (compatibility version 6.0.0, current version 6.2.0)
    /usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 159.1.0)
</code></pre>

<p>And in the output you should see a line listing "libreadline", and no lines listing "libedit". Which that shows, we've compiled it properly then. Now the bundle is built we need to move it into the right place so it's loaded when ruby is invoked.</p>

<pre><code>$ RL_PATH="/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/lib/ruby/1.8/universal-darwin11.0"
# Back up the original bundle, just in cases
$ sudo mv "$RL_PATH/readline.bundle" "$RL_PATH/readline.bundle.libedit"
$ sudo mv readline.bundle "$RL_PATH/readline.bundle"
</code></pre>

<p>And that's it. You've got a proper compiled-against-readline installed ruby 1.8.7-p249 on 10.7 now.</p>

<p>One gotcha I ran into was needing to pass the same arguments to rvm when installing any other version of 1.8.7 on the same machine. Simple enough, just need to remember to do it though.</p>

<pre><code>$ CC=gcc-4.2 rvm install 1.8.7-p357 -C --with-readline-dir=$(brew --prefix readline) --disable-libedit
</code></pre>


    </main>

    <nav>
      <div class="archives">
        <h3>Archives</h3>
<!--        <ul>
            <li></li>
        </ul>
-->
      </div>

      <div class="feed">
        <link rel="alternate" type="application/rss+xml" title="Syndicate (atom)" href="/feed/" />
      </div>
    </nav>

    <span class="clear"></span>

    <footer>
      <p class="first">
        <a href="/">CaiusTheory</a>
      </p>
      <p class="last">
        Inspired by <a href="http://labs.utopian.net/habari/theme/sp/">sp</a>
      </p>
      <span class="clear"></span>
    </footer>
  </body>
</html>

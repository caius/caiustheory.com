<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Compiling SmartOS for AMD processors - CaiusTheory</title>

    <link rel="alternate" type="application/atom+xml" title="Caius Theory" href="/feed/" />

    <link rel="stylesheet" href="/stylesheets/stylesheet.css" type="text/css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>

    <header>
      <h1><a href="/">Caius Theory</a></h1>
      <h2>Now with even more cowbell&hellip;</h2>
    </header>

    <main>
      <p>There's a few community-provided patches for SmartOS that enable KVM on AMD processors amongst other things, and given the HP Microserver has an AMD processor, that's quite useful for turning it into a better lab server. The main <a href="http://imgapi.uqcloud.net/builds">list of so called "eait" builds</a> was hiccuping when I tried to download the latest, and all I could find was a 20140812T062241Z image <a href="http://builds.smartos.skylime.net">here</a>.</p>

<p>The source code for the eait builds is maintained at <a href="https://github.com/arekinath/smartos-live">https://github.com/arekinath/smartos-live</a>, and you can see the patches applied on top of the normal SmartOS master by going to <a href="https://github.com/arekinath/smartos-live/compare/joyent:master...eait">https://github.com/arekinath/smartos-live/compare/joyent:master...eait</a>.</p>

<p>So here's how to use SmartOS to compile a more up to date AMD-friendly Smartos!</p>

<ol>
  <li>
    <p>Grab the latest multiarch SmartOS image (which <strong>has</strong> to be used, or the compile will fail.) The latest at the time of writing was <code>4aec529c-55f9-11e3-868e-a37707fcbe86</code>, so that's what I'll use.</p>

    <pre><code> imgadm import 4aec529c-55f9-11e3-868e-a37707fcbe86
</code></pre>
  </li>
  <li>
    <p>Spin up a zone for us to build in (the <a href="http://wiki.smartos.org/display/DOC/Building+SmartOS+on+SmartOS">Building SmartOS on SmartOS</a> page has extra info about this):</p>

    <pre><code> echo '{
   "alias": "platform-builder",
   "brand": "joyent",
   "dataset_uuid": "4aec529c-55f9-11e3-868e-a37707fcbe86",
   "max_physical_memory": 32768,
   "quota": 0,
   "tmpfs": 8192,
   "fs_allowed": "ufs,pcfs,tmpfs",
   "maintain_resolvers": true,
   "resolvers": [
     "8.8.8.8",
     "8.8.4.4"
   ],
   "nics": [
     {
       "nic_tag": "admin",
       "ip": "dhcp",
       "primary": true
     }
   ],
   "internal_metadata": {
     "root_pw": "password",
     "admin_pw": "password"
   }
 }' | vmadm create
</code></pre>
  </li>
  <li>
    <p>Login to the created zone:</p>

    <pre><code> zlogin &lt;uuid from `vmadm create` output&gt;
</code></pre>
  </li>
  <li>
    <p>Update the image to the latest packages, etc:</p>

    <pre><code> pkgin -y update &amp;&amp; pkgin -y full-upgrade
</code></pre>
  </li>
  <li>
    <p>Install a few images we'll need to compile &amp; package SmartOS:</p>

    <pre><code> pkgin install scmgit cdrtools pbzip2
</code></pre>
  </li>
  <li>
    <p>Grab the source code of the fork containing the patches we want, from <a href="https://github.com/arekinath/smartos-live">arekinath/smartos-live</a></p>

    <pre><code> git clone https://github.com/arekinath/smartos-live
 cd smartos-live
</code></pre>
  </li>
  <li>
    <p><em>Optional</em>: Edit <code>src/Makefile.defs</code> and change <code>PARALLEL =      -j$(MAX_JOBS)</code> to <code>PARALLEL =      -j8</code> to do less at once. (Microserver only has a dual core CPU!)</p>
  </li>
  <li>
    <p>Copy the configure definition into the right place and start configuration:</p>

    <pre><code> cp {sample.,}configure.smartos
 ./configure
</code></pre>

    <p><em>(You'll probably get asked to accept the java license during configuration, so keep half an eye on it)</em></p>
  </li>
  <li>
    <p>Once configure has completed (which doesn't take <em>too</em> long, 15 minutes or so), start building:</p>

    <pre><code> gmake world &amp;&amp; gmake live
</code></pre>
  </li>
  <li>
    <p>Once the build is successfully finished, time to package an iso &amp; usb image:</p>

    <pre><code>export LC_ALL=C
tools/build_iso
tools/build_usb
</code></pre>
  </li>
</ol>

<p>Hey presto, you've a freshly built AMD-friendly SmartOS build to flash to a USB key / put on your netboot server and boot your Microserver from!</p>

<hr />

<p><strong>References</strong></p>

<ul>
  <li><a href="http://wiki.smartos.org/display/DOC/Building+SmartOS+on+SmartOS">http://wiki.smartos.org/display/DOC/Building+SmartOS+on+SmartOS</a></li>
  <li><a href="https://github.com/arekinath/smartos-live">https://github.com/arekinath/smartos-live</a></li>
</ul>

    </main>

    <nav>
      <div class="archives">
        <h3>Archives</h3>
<!--        <ul>
            <li></li>
        </ul>
-->
      </div>

      <div class="feed">
        <link rel="alternate" type="application/rss+xml" title="Syndicate (atom)" href="/feed/" />
      </div>
    </nav>

    <span class="clear"></span>

    <footer>
      <p class="first">
        <a href="/">CaiusTheory</a>
      </p>
      <p class="last">
        Inspired by <a href="http://labs.utopian.net/habari/theme/sp/">sp</a>
      </p>
      <span class="clear"></span>
    </footer>
  </body>
</html>
